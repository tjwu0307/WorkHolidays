<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工作上班休假紀錄</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">工作上班休假紀錄</h1>
            <p class="text-gray-600">管理您的工作休假與國定假日</p>
        </div>

        <!-- 單欄緊湊佈局 -->
        <div class="max-w-6xl mx-auto space-y-4">
                <!-- 員工基本資訊 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <span class="bg-blue-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">1</span>
                        員工基本資訊
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">姓名</label>
                            <input type="text" id="employeeName" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="請輸入姓名">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">年度起始日期</label>
                            <input type="date" id="startDate" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">年度結束日期</label>
                            <input type="date" id="endDate" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-gray-50" readonly>
                        </div>
                    </div>
                </div>

                <!-- 特休統計 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <span class="bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">📊</span>
                        特休統計
                    </h2>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <div class="bg-blue-50 rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-blue-600">10</div>
                            <div class="text-xs text-gray-600">年度總天數</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-green-600">80</div>
                            <div class="text-xs text-gray-600">年度總小時</div>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-orange-600" id="usedDays">0</div>
                            <div class="text-xs text-gray-600">已使用天數</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-purple-600" id="remainingDays">10</div>
                            <div class="text-xs text-gray-600">剩餘天數</div>
                        </div>
                        <div class="bg-indigo-50 rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-indigo-600" id="remainingHours">80</div>
                            <div class="text-xs text-gray-600">剩餘小時</div>
                        </div>
                    </div>
                </div>

                <!-- 工作日倒數計算 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <span class="bg-yellow-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">📅</span>
                        工作日倒數計算
                    </h2>
                    <div class="space-y-3">
                        <div class="bg-yellow-50 rounded-lg p-3 text-center">
                            <div class="text-xl font-bold text-yellow-600" id="workingDaysCount">計算中...</div>
                            <div class="text-xs text-gray-600">距離春節假期2026/2/14(週六)剩餘工作日</div>
                        </div>
                        <div class="max-h-48 overflow-y-auto">
                            <div id="holidayList">
                                <!-- 國定假日和特休列表將在這裡顯示 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 特休紀錄列表 -->
                <div class="bg-white rounded-lg shadow-lg p-4">
                    <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                        <span class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">📋</span>
                        特休紀錄
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">申請日期</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">休假期間</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">天數</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">小時數</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">事由</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">備註</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-700">操作</th>
                                </tr>
                            </thead>
                            <tbody id="leaveRecords" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-2 py-4 text-center text-gray-500 text-sm">
                                        尚無特休紀錄，請新增第一筆申請
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            <!-- 新增特休申請 -->
            <div class="bg-white rounded-lg shadow-lg p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="bg-indigo-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2" id="formIcon">+</span>
                    <span id="formTitle">新增特休申請</span>
                </h2>
                <form id="leaveForm" class="space-y-3">
                    <!-- 第1列：申請日期/事由/備註 -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">申請日期</label>
                            <input type="date" id="applicationDate" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">事由</label>
                            <input type="text" id="reason" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="請輸入休假事由" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">備註</label>
                            <input type="text" id="notes" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="其他備註事項（選填）">
                        </div>
                    </div>
                    
                    <!-- 第2列：開始日期/開始時間/結束日期/結束時間 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">開始日期</label>
                            <input type="date" id="leaveStartDate" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">開始時間</label>
                            <input type="time" id="leaveStartTime" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="09:00" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">結束日期</label>
                            <input type="date" id="leaveEndDate" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">結束時間</label>
                            <input type="time" id="leaveEndTime" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="18:00" required>
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 px-3 text-sm rounded hover:bg-indigo-700 transition duration-200 font-medium" id="submitBtn">
                            新增特休申請
                        </button>
                        <button type="button" onclick="cancelEdit()" class="flex-1 border border-gray-300 text-gray-700 py-2 px-3 text-sm rounded hover:bg-gray-50 transition duration-200 font-medium" id="cancelBtn" style="display: none;">
                            取消
                        </button>
                    </div>
                </form>
            </div>

            <!-- 新增國定假日 -->
            <div class="bg-white rounded-lg shadow-lg p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="bg-purple-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2">🎉</span>
                    新增國定假日
                </h2>
                <form id="holidayForm">
                    <!-- 名稱/日期 並排 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">假日名稱</label>
                            <input type="text" id="holidayName" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500" placeholder="例：春節" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">假日日期</label>
                            <input type="date" id="holidayDate" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-purple-500" required>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white py-2 px-3 text-sm rounded hover:bg-purple-700 transition duration-200 font-medium">
                        新增國定假日
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let leaveRecords = JSON.parse(localStorage.getItem('leaveRecords')) || [];
        let holidays = JSON.parse(localStorage.getItem('holidays')) || [];
        let recordIdCounter = Math.max(...leaveRecords.map(r => r.id), 0) + 1;
        let holidayIdCounter = Math.max(...holidays.map(h => h.id), 0) + 1;
        let editingRecordId = null;

        // 計算年度結束日期（起始日期+1年-1天）
        function calculateEndDate(startDateValue) {
            if (!startDateValue) return '';
            
            const startDate = new Date(startDateValue);
            const endDate = new Date(startDate);
            endDate.setFullYear(startDate.getFullYear() + 1);
            endDate.setDate(endDate.getDate() - 1);
            
            return endDate.toISOString().split('T')[0];
        }

        // 設定預設日期
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const currentYear = today.getFullYear();
            
            // 設定年度起始日期
            const startDateInput = document.getElementById('startDate');
            startDateInput.value = `${currentYear}-01-01`;
            
            // 自動計算並設定年度結束日期
            document.getElementById('endDate').value = calculateEndDate(startDateInput.value);
            
            // 設定申請日期為今天
            document.getElementById('applicationDate').value = today.toISOString().split('T')[0];
            
            // 監聽起始日期變更
            startDateInput.addEventListener('change', function() {
                document.getElementById('endDate').value = calculateEndDate(this.value);
            });

            // 監聽休假開始日期變更，自動設定結束日期和時間
            document.getElementById('leaveStartDate').addEventListener('change', function() {
                const startDate = this.value;
                if (startDate) {
                    document.getElementById('leaveEndDate').value = startDate;
                    document.getElementById('leaveEndTime').value = '18:00';
                }
            });

            // 初始化預設的國定假日
            initializeDefaultHolidays();
            updateWorkingDaysCalculation();
        });

        // 初始化預設國定假日
        function initializeDefaultHolidays() {
            // 如果已有假日資料，就不初始化預設值
            if (holidays.length > 0) return;
            
            const defaultHolidays = [
                // 2025年國定假日
                { name: '元旦', date: '2025-01-01' },
                { name: '春節', date: '2025-01-28' },
                { name: '春節', date: '2025-01-29' },
                { name: '春節', date: '2025-01-30' },
                { name: '春節', date: '2025-01-31' },
                { name: '春節', date: '2025-02-01' },
                { name: '和平紀念日', date: '2025-02-28' },
                { name: '兒童節', date: '2025-04-04' },
                { name: '清明節', date: '2025-04-05' },
                { name: '勞動節', date: '2025-05-01' },
                { name: '端午節', date: '2025-05-31' },
                { name: '教師節', date: '2025-09-28' },
                { name: '中秋節', date: '2025-10-06' },
                { name: '國慶日', date: '2025-10-10' },
                { name: '光復節', date: '2025-10-24' },
                { name: '行憲紀念日', date: '2025-12-25' },
                // 2026年國定假日
                { name: '元旦', date: '2026-01-01' },
                { name: '春節', date: '2026-02-14' },
                { name: '春節', date: '2026-02-15' },
                { name: '春節', date: '2026-02-16' },
                { name: '春節', date: '2026-02-17' },
                { name: '春節', date: '2026-02-18' }
            ];

            defaultHolidays.forEach(holiday => {
                holidays.push({
                    id: holidayIdCounter++,
                    name: holiday.name,
                    date: holiday.date
                });
            });
            
            // 儲存到 localStorage
            localStorage.setItem('holidays', JSON.stringify(holidays));
        }

        // 計算休假小時數（精確計算時間差）
        function calculateLeaveHours(startDate, startTime, endDate, endTime) {
            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            
            // 計算總小時數
            const timeDiff = end.getTime() - start.getTime();
            const hours = timeDiff / (1000 * 3600);
            
            return Math.max(0, Math.round(hours * 100) / 100); // 保留兩位小數
        }

        // 計算休假天數（小時數除以8）
        function calculateLeaveDays(hours) {
            return Math.round((hours / 8) * 100) / 100; // 保留兩位小數
        }

        // 計算工作日（排除週末、國定假日、特休）
        function calculateWorkingDays() {
            const today = new Date();
            const springFestival = new Date('2026-02-14'); // 2026年春節日期
            
            let workingDays = 0;
            let currentDate = new Date(today);
            
            while (currentDate <= springFestival) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayOfWeek = currentDate.getDay();
                
                // 排除週末
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    // 檢查是否為國定假日
                    const isHoliday = holidays.some(holiday => holiday.date === dateStr);
                    // 檢查是否為特休日
                    const isLeaveDay = leaveRecords.some(record => {
                        const startDate = new Date(record.startDate);
                        const endDate = new Date(record.endDate);
                        const checkDate = new Date(dateStr);
                        return checkDate >= startDate && checkDate <= endDate;
                    });
                    
                    if (!isHoliday && !isLeaveDay) {
                        workingDays++;
                    }
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return workingDays;
        }

        // 更新工作日計算和假日列表
        function updateWorkingDaysCalculation() {
            const workingDays = calculateWorkingDays();
            document.getElementById('workingDaysCount').textContent = workingDays;
            
            // 更新假日列表
            const holidayList = document.getElementById('holidayList');
            const allDates = [];
            
            // 添加國定假日
            holidays.forEach(holiday => {
                allDates.push({
                    date: holiday.date,
                    name: holiday.name,
                    type: 'holiday'
                });
            });
            
            // 添加特休日
            leaveRecords.forEach(record => {
                const startDate = new Date(record.startDate);
                const endDate = new Date(record.endDate);
                let currentDate = new Date(startDate);
                
                while (currentDate <= endDate) {
                    allDates.push({
                        date: currentDate.toISOString().split('T')[0],
                        name: record.reason,
                        type: 'leave'
                    });
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            });
            
            // 排序並顯示
            allDates.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // 分為兩欄顯示
            const holidayDates = allDates.filter(item => item.type === 'holiday');
            const leaveDates = allDates.filter(item => item.type === 'leave');
            
            function getWeekday(dateStr) {
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                const date = new Date(dateStr);
                return weekdays[date.getDay()];
            }
            
            holidayList.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="text-sm font-medium text-blue-600 mb-2">國定假日</h4>
                        <div class="space-y-1">
                            ${holidayDates.map(item => `
                                <div class="flex justify-between items-center p-2 rounded bg-blue-50">
                                    <span class="text-blue-600 font-medium text-sm">${item.name}</span>
                                    <span class="text-xs text-gray-500">${item.date} (${getWeekday(item.date)})</span>
                                </div>
                            `).join('')}
                            ${holidayDates.length === 0 ? '<div class="text-xs text-gray-400 p-2">無國定假日</div>' : ''}
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-medium text-red-600 mb-2">特休假期</h4>
                        <div class="space-y-1">
                            ${leaveDates.map(item => `
                                <div class="flex justify-between items-center p-2 rounded bg-red-50">
                                    <span class="text-red-600 font-medium text-sm">${item.name}</span>
                                    <span class="text-xs text-gray-500">${item.date} (${getWeekday(item.date)})</span>
                                </div>
                            `).join('')}
                            ${leaveDates.length === 0 ? '<div class="text-xs text-gray-400 p-2">無特休假期</div>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // 更新統計資訊
        function updateStatistics() {
            const totalUsedDays = leaveRecords.reduce((sum, record) => sum + record.days, 0);
            const totalUsedHours = leaveRecords.reduce((sum, record) => sum + record.hours, 0);
            const remainingDays = Math.max(0, 10 - totalUsedDays);
            const remainingHours = Math.max(0, 80 - totalUsedHours);

            document.getElementById('usedDays').textContent = totalUsedDays.toFixed(2);
            document.getElementById('remainingDays').textContent = remainingDays.toFixed(2);
            document.getElementById('remainingHours').textContent = remainingHours.toFixed(0);
            
            updateWorkingDaysCalculation();
        }

        // 渲染紀錄表格
        function renderRecords() {
            const tbody = document.getElementById('leaveRecords');
            
            if (leaveRecords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            尚無特休紀錄，請新增第一筆申請
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = leaveRecords.map(record => `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-2 text-xs text-gray-900">${record.applicationDate}</td>
                    <td class="px-2 py-2 text-xs text-gray-900">
                        ${record.startDate} ${record.startTime}<br>
                        <span class="text-gray-500">至</span><br>
                        ${record.endDate} ${record.endTime}
                    </td>
                    <td class="px-2 py-2 text-xs font-medium text-blue-600">${record.days}</td>
                    <td class="px-2 py-2 text-xs text-gray-900">${record.hours}h</td>
                    <td class="px-2 py-2 text-xs text-gray-900">${record.reason}</td>
                    <td class="px-2 py-2 text-xs text-gray-500">${record.notes || '-'}</td>
                    <td class="px-2 py-2 text-xs">
                        <button onclick="editRecord(${record.id})" class="text-blue-600 hover:text-blue-800 font-medium mr-2 text-xs">
                            修改
                        </button>
                        <button onclick="deleteRecord(${record.id})" class="text-red-600 hover:text-red-800 font-medium text-xs">
                            刪除
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 修改紀錄
        function editRecord(id) {
            const record = leaveRecords.find(r => r.id === id);
            if (!record) return;

            // 填入表單
            document.getElementById('applicationDate').value = record.applicationDate;
            document.getElementById('leaveStartDate').value = record.startDate;
            document.getElementById('leaveStartTime').value = record.startTime;
            document.getElementById('leaveEndDate').value = record.endDate;
            document.getElementById('leaveEndTime').value = record.endTime;
            document.getElementById('reason').value = record.reason;
            document.getElementById('notes').value = record.notes || '';

            // 更新UI狀態
            editingRecordId = id;
            document.getElementById('formTitle').textContent = '修改特休申請';
            document.getElementById('formIcon').textContent = '✏️';
            document.getElementById('submitBtn').textContent = '更新特休申請';
            document.getElementById('cancelBtn').style.display = 'block';

            // 滾動到表單
            document.getElementById('leaveForm').scrollIntoView({ behavior: 'smooth' });
        }

        // 取消修改
        function cancelEdit() {
            editingRecordId = null;
            document.getElementById('formTitle').textContent = '新增特休申請';
            document.getElementById('formIcon').textContent = '+';
            document.getElementById('submitBtn').textContent = '新增特休申請';
            document.getElementById('cancelBtn').style.display = 'none';
            
            // 重置表單
            document.getElementById('leaveForm').reset();
            document.getElementById('applicationDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('leaveStartTime').value = '09:00';
            document.getElementById('leaveEndTime').value = '18:00';
        }

        // 刪除紀錄
        function deleteRecord(id) {
            if (confirm('確定要刪除這筆特休紀錄嗎？')) {
                leaveRecords = leaveRecords.filter(record => record.id !== id);
                
                // 儲存到 localStorage
                localStorage.setItem('leaveRecords', JSON.stringify(leaveRecords));
                
                // 如果正在修改這筆紀錄，取消修改狀態
                if (editingRecordId === id) {
                    cancelEdit();
                }
                
                renderRecords();
                updateStatistics();
            }
        }

        // 特休表單提交處理
        document.getElementById('leaveForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const applicationDate = document.getElementById('applicationDate').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const startTime = document.getElementById('leaveStartTime').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const endTime = document.getElementById('leaveEndTime').value;
            const reason = document.getElementById('reason').value;
            const notes = document.getElementById('notes').value;

            // 驗證日期邏輯
            const start = new Date(`${startDate}T${startTime}`);
            const end = new Date(`${endDate}T${endTime}`);
            
            if (end <= start) {
                alert('結束時間必須晚於開始時間！');
                return;
            }

            const hours = calculateLeaveHours(startDate, startTime, endDate, endTime);
            const days = calculateLeaveDays(hours);

            // 檢查是否超過剩餘特休（修改時要排除原本的紀錄）
            let totalUsedDays = leaveRecords.reduce((sum, record) => {
                if (editingRecordId && record.id === editingRecordId) {
                    return sum; // 修改時排除原本的紀錄
                }
                return sum + record.days;
            }, 0);
            
            if (totalUsedDays + days > 10) {
                alert(`申請天數超過剩餘特休！剩餘天數：${10 - totalUsedDays} 天`);
                return;
            }

            if (editingRecordId) {
                // 修改現有紀錄
                const recordIndex = leaveRecords.findIndex(r => r.id === editingRecordId);
                if (recordIndex !== -1) {
                    leaveRecords[recordIndex] = {
                        id: editingRecordId,
                        applicationDate,
                        startDate,
                        startTime,
                        endDate,
                        endTime,
                        hours: hours,
                        days: days,
                        reason,
                        notes
                    };
                }
                
                // 儲存到 localStorage
                localStorage.setItem('leaveRecords', JSON.stringify(leaveRecords));
                
                alert('特休申請已成功更新！');
                cancelEdit(); // 重置表單狀態
            } else {
                // 新增紀錄
                const newRecord = {
                    id: recordIdCounter++,
                    applicationDate,
                    startDate,
                    startTime,
                    endDate,
                    endTime,
                    hours: hours,
                    days: days,
                    reason,
                    notes
                };

                leaveRecords.push(newRecord);
                
                // 儲存到 localStorage
                localStorage.setItem('leaveRecords', JSON.stringify(leaveRecords));
                
                // 重置表單
                document.getElementById('leaveForm').reset();
                document.getElementById('applicationDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('leaveStartTime').value = '09:00';
                document.getElementById('leaveEndTime').value = '18:00';

                alert('特休申請已成功新增！');
            }

            // 更新顯示
            renderRecords();
            updateStatistics();
        });

        // 國定假日表單提交處理
        document.getElementById('holidayForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const name = document.getElementById('holidayName').value;
            const date = document.getElementById('holidayDate').value;

            // 檢查是否已存在相同日期的假日
            const existingHoliday = holidays.find(h => h.date === date);
            if (existingHoliday) {
                alert('該日期已存在國定假日！');
                return;
            }

            // 新增國定假日
            holidays.push({
                id: holidayIdCounter++,
                name: name,
                date: date
            });

            // 儲存到 localStorage
            localStorage.setItem('holidays', JSON.stringify(holidays));

            // 重置表單
            document.getElementById('holidayForm').reset();
            
            // 更新顯示
            updateWorkingDaysCalculation();
            
            alert('國定假日已成功新增！');
        });

        // 初始化
        renderRecords();
        updateStatistics();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97aec75672d4f1dc',t:'MTc1NzE3MDIyNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
