<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å·¥ä½œä¸Šç­ä¼‘å‡ç´€éŒ„ï¼ˆæ”¹ç‰ˆï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans TC', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
    /* æ›´ç·Šæ¹Šçš„è¡¨æ ¼å­—è· */
    table td, table th { line-height: 1.2; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-6xl mx-auto px-3 sm:px-4 lg:px-6 py-5">
    <!-- æ¨™é¡Œ -->
    <header class="text-center mb-5">
      <h1 class="text-2xl font-bold text-slate-800">å·¥ä½œä¸Šç­ä¼‘å‡ç´€éŒ„</h1>
      <p class="text-slate-500 text-sm">å·¦å³é›™æ¬„ã€æ‰¹æ¬¡åŒ¯å…¥åœ‹å®šå‡æ—¥ã€æ’é™¤å…­æ—¥èˆ‡å‡æ—¥è¨ˆç®—ã€0.5 å°æ™‚ç‚ºæœ€å°å–®ä½</p>
    </header>

    <!-- ä¸»è¦ç‰ˆé¢ï¼šå·¦æ‘˜è¦ / å³æ¸…å–®èˆ‡è¡¨å–® -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- å·¦æ¬„ï¼ˆè¼ƒçª„ï¼‰ -->
      <aside class="lg:col-span-1 space-y-4">
        <!-- å“¡å·¥åŸºæœ¬è³‡è¨Š -->
        <section class="bg-white rounded-lg shadow p-3">
          <h2 class="text-base font-semibold text-slate-800 mb-2 flex items-center"><span class="w-5 h-5 text-xs bg-blue-600 text-white rounded-full flex items-center justify-center mr-2">1</span>å“¡å·¥åŸºæœ¬è³‡è¨Š</h2>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
            <label class="text-xs text-slate-600">
              å§“å
              <input id="employeeName" type="text" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å§“å" />
            </label>
            <label class="text-xs text-slate-600">
              å¹´åº¦èµ·å§‹æ—¥æœŸ
              <input id="startDate" type="date" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
            </label>
            <label class="text-xs text-slate-600">
              å¹´åº¦çµæŸæ—¥æœŸ
              <input id="endDate" type="date" class="mt-1 w-full px-2 py-1 text-sm border rounded bg-slate-50 text-slate-500" readonly />
            </label>
          </div>
        </section>

        <!-- ç‰¹ä¼‘çµ±è¨ˆ -->
        <section class="bg-white rounded-lg shadow p-3">
          <h2 class="text-base font-semibold text-slate-800 mb-2 flex items-center"><span class="w-5 h-5 text-xs bg-emerald-600 text-white rounded-full flex items-center justify-center mr-2">ğŸ“Š</span>ç‰¹ä¼‘çµ±è¨ˆ</h2>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
            <div class="bg-blue-50 rounded p-2 text-center">
              <div class="text-lg font-bold text-blue-700" id="totalDays">10</div>
              <div class="text-[11px] text-slate-600">å¹´åº¦ç¸½å¤©æ•¸</div>
            </div>
            <div class="bg-emerald-50 rounded p-2 text-center">
              <div class="text-lg font-bold text-emerald-700" id="totalHours">80</div>
              <div class="text-[11px] text-slate-600">å¹´åº¦ç¸½å°æ™‚</div>
            </div>
            <div class="bg-orange-50 rounded p-2 text-center">
              <div class="text-lg font-bold text-orange-700" id="usedDays">0.00</div>
              <div class="text-[11px] text-slate-600">å·²ä½¿ç”¨å¤©æ•¸</div>
            </div>
            <div class="bg-violet-50 rounded p-2 text-center">
              <div class="text-lg font-bold text-violet-700" id="remainingDays">10.00</div>
              <div class="text-[11px] text-slate-600">å‰©é¤˜å¤©æ•¸</div>
            </div>
            <div class="bg-indigo-50 rounded p-2 text-center">
              <div class="text-lg font-bold text-indigo-700" id="remainingHours">80</div>
              <div class="text-[11px] text-slate-600">å‰©é¤˜å°æ™‚</div>
            </div>
          </div>
        </section>

        <!-- å·¥ä½œæ—¥å€’æ•¸ï¼ˆä¸è¨ˆå…­æ—¥èˆ‡åœ‹å®šå‡æ—¥ï¼‰ -->
        <section class="bg-white rounded-lg shadow p-3">
          <h2 class="text-base font-semibold text-slate-800 mb-2 flex items-center"><span class="w-5 h-5 text-xs bg-amber-500 text-white rounded-full flex items-center justify-center mr-2">ğŸ“…</span>å·¥ä½œæ—¥å€’æ•¸</h2>
          <div class="grid grid-cols-2 gap-2 items-end mb-2">
            <label class="text-xs text-slate-600">
              ç›®æ¨™æ—¥æœŸ
              <input id="targetDate" type="date" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-amber-500" />
            </label>
            <button id="recalcCountdown" class="h-9 mt-6 bg-amber-600 hover:bg-amber-700 text-white text-sm rounded">é‡æ–°è¨ˆç®—</button>
          </div>
          <div class="bg-amber-50 rounded p-2 text-center">
            <div class="text-lg font-bold text-amber-700" id="workingDaysCount">â€”</div>
            <div class="text-[12px] text-slate-600" id="countdownLabel">è·é›¢ç›®æ¨™æ—¥å‰©é¤˜å·¥ä½œæ—¥ï¼ˆä¸å«å…­æ—¥èˆ‡åœ‹å®šå‡æ—¥ï¼‰</div>
          </div>

          <div class="mt-3">
            <details class="rounded border border-slate-200 bg-slate-50 p-2">
              <summary class="cursor-pointer text-sm text-slate-700">æŸ¥çœ‹åœ‹å®šå‡æ—¥èˆ‡ç‰¹ä¼‘æ—¥æœŸ</summary>
              <div class="mt-2 max-h-40 overflow-y-auto" id="holidayList"></div>
            </details>
          </div>
        </section>

        <!-- åœ‹å®šå‡æ—¥ï¼šå–®ç­†æ–°å¢ & æ‰¹æ¬¡åŒ¯å…¥ -->
        <section class="bg-white rounded-lg shadow p-3">
          <h2 class="text-base font-semibold text-slate-800 mb-2 flex items-center"><span class="w-5 h-5 text-xs bg-fuchsia-600 text-white rounded-full flex items-center justify-center mr-2">ğŸ‰</span>åœ‹å®šå‡æ—¥</h2>

          <!-- å–®ç­†æ–°å¢ -->
          <form id="holidayForm" class="mb-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
              <label class="text-xs text-slate-600">å‡æ—¥åç¨±
                <input id="holidayName" type="text" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-fuchsia-500" placeholder="ä¾‹ï¼šæ˜¥ç¯€" required />
              </label>
              <label class="text-xs text-slate-600">å‡æ—¥æ—¥æœŸ
                <input id="holidayDate" type="date" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-fuchsia-500" required />
              </label>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm rounded py-2">æ–°å¢åœ‹å®šå‡æ—¥</button>
              <button type="button" id="clearHolidays" class="flex-1 border text-slate-700 text-sm rounded py-2 hover:bg-slate-50">æ¸…é™¤å…¨éƒ¨</button>
            </div>
          </form>

          <!-- æ‰¹æ¬¡åŒ¯å…¥ -->
          <details class="rounded border border-slate-200 bg-slate-50 p-2">
            <summary class="cursor-pointer text-sm text-slate-700">æ‰¹æ¬¡åŒ¯å…¥ï¼ˆè²¼ä¸Šå¤šç­†ï¼‰</summary>
            <div class="mt-2 space-y-2">
              <p class="text-[12px] text-slate-600">æ¯è¡Œä¸€ç­†ï¼Œæ”¯æ´ä¸‰ç¨®æ ¼å¼ï¼š<br>â‘  <code>YYYY-MM-DD,åç¨±</code>ã€€â‘¡ <code>YYYY/MM/DD åç¨±</code>ã€€â‘¢ å¾ Excel è²¼ä¸Šå…©æ¬„ï¼ˆæ—¥æœŸâ†¹åç¨±ï¼‰</p>
              <textarea id="bulkText" rows="5" class="w-full text-sm px-2 py-1 border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="ä¾‹ï¼š\n2025-10-10,åœ‹æ…¶æ—¥\n2026/02/14 æ˜¥ç¯€å‡æœŸé–‹å§‹"></textarea>
              <div class="flex gap-2 items-center">
                <label class="inline-flex items-center gap-1 text-sm text-slate-700"><input id="bulkOverwrite" type="checkbox" class="rounded" /> è¦†è“‹ç¾æœ‰å‡æ—¥</label>
                <button id="bulkImport" class="ml-auto bg-indigo-600 hover:bg-indigo-700 text-white text-sm rounded px-3 py-2">åŒ¯å…¥</button>
              </div>
            </div>
          </details>
        </section>
      </aside>

      <!-- å³æ¬„ï¼ˆè¼ƒå¯¬ï¼‰ -->
      <main class="lg:col-span-2 space-y-4">
        <!-- ç‰¹ä¼‘ç´€éŒ„åˆ—è¡¨ -->
        <section class="bg-white rounded-lg shadow p-3">
          <h2 class="text-base font-semibold text-slate-800 mb-2 flex items-center"><span class="w-5 h-5 text-xs bg-rose-600 text-white rounded-full flex items-center justify-center mr-2">ğŸ“‹</span>ç‰¹ä¼‘ç´€éŒ„</h2>
          <div class="overflow-x-auto">
            <table class="w-full table-auto text-sm">
              <thead>
                <tr class="bg-slate-50 text-xs text-slate-700">
                  <th class="px-2 py-2 text-left">ç”³è«‹æ—¥æœŸ</th>
                  <th class="px-2 py-2 text-left">ä¼‘å‡æœŸé–“</th>
                  <th class="px-2 py-2 text-left">å¤©æ•¸</th>
                  <th class="px-2 py-2 text-left">å°æ™‚æ•¸</th>
                  <th class="px-2 py-2 text-left">äº‹ç”±</th>
                  <th class="px-2 py-2 text-left">å‚™è¨»</th>
                  <th class="px-2 py-2 text-left">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="leaveRecords" class="divide-y divide-slate-200">
                <tr><td colspan="7" class="px-2 py-6 text-center text-slate-500 text-sm">å°šç„¡ç‰¹ä¼‘ç´€éŒ„ï¼Œè«‹æ–°å¢ç¬¬ä¸€ç­†ç”³è«‹</td></tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- æ–°å¢/ä¿®æ”¹ ç‰¹ä¼‘ç”³è«‹ -->
        <section class="bg-white rounded-lg shadow p-3">
          <h2 class="text-base font-semibold text-slate-800 mb-2 flex items-center"><span id="formIcon" class="w-5 h-5 text-xs bg-indigo-600 text-white rounded-full flex items-center justify-center mr-2">+</span><span id="formTitle">æ–°å¢ç‰¹ä¼‘ç”³è«‹</span></h2>
          <form id="leaveForm" class="space-y-2">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <label class="text-xs text-slate-600">ç”³è«‹æ—¥æœŸ
                <input id="applicationDate" type="date" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" required />
              </label>
              <label class="text-xs text-slate-600">äº‹ç”±
                <input id="reason" type="text" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="è«‹è¼¸å…¥ä¼‘å‡äº‹ç”±" required />
              </label>
              <label class="text-xs text-slate-600">å‚™è¨»
                <input id="notes" type="text" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="å…¶ä»–å‚™è¨»äº‹é …ï¼ˆé¸å¡«ï¼‰" />
              </label>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
              <label class="text-xs text-slate-600">é–‹å§‹æ—¥æœŸ
                <input id="leaveStartDate" type="date" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" required />
              </label>
              <label class="text-xs text-slate-600">é–‹å§‹æ™‚é–“
                <input id="leaveStartTime" type="time" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="09:00" required />
              </label>
              <label class="text-xs text-slate-600">çµæŸæ—¥æœŸ
                <input id="leaveEndDate" type="date" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" required />
              </label>
              <label class="text-xs text-slate-600">çµæŸæ™‚é–“
                <input id="leaveEndTime" type="time" class="mt-1 w-full px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" value="18:00" required />
              </label>
            </div>

            <div class="flex gap-2">
              <button id="submitBtn" type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-2 text-sm rounded">æ–°å¢ç‰¹ä¼‘ç”³è«‹</button>
              <button id="cancelBtn" type="button" class="flex-1 border text-slate-700 py-2 text-sm rounded hover:bg-slate-50 hidden" onclick="cancelEdit()">å–æ¶ˆ</button>
            </div>
          </form>
        </section>
      </main>
    </div>
  </div>

  <script>
    // ====== è¨­å®šå€¼ï¼ˆå¯ä¾éœ€è¦èª¿æ•´ï¼‰ ======
    const WORK_START = '09:00';
    const LUNCH_START = '12:00';
    const LUNCH_END   = '13:00';
    const WORK_END   = '18:00'; // å«åˆä¼‘ä¸€å°æ™‚ï¼Œç¸½å·¥æ™‚ 8 å°æ™‚
    const DAY_HOURS = 8;

    // ====== ç‹€æ…‹ ======
    let leaveRecords = JSON.parse(localStorage.getItem('leaveRecords') || '[]');
    let holidays = JSON.parse(localStorage.getItem('holidays') || '[]');
    let recordIdCounter = (leaveRecords.length ? Math.max(...leaveRecords.map(r => r.id)) : 0) + 1;
    let holidayIdCounter = (holidays.length ? Math.max(...holidays.map(h => h.id)) : 0) + 1;
    let editingRecordId = null;

    // ====== å·¥å…·å‡½å¼ ======
    const zpad = n => (n < 10 ? '0' + n : '' + n);
    const fmtDate = d => `${d.getFullYear()}-${zpad(d.getMonth()+1)}-${zpad(d.getDate())}`;
    const parseDate = s => { const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); };
    const parseDateFlex = s => { // æ”¯æ´ 2025/10/10 æˆ– 2025-10-10
      const t = s.includes('/') ? s.split('/') : s.split('-');
      const [y,m,d] = t.map(v => parseInt(v,10));
      return new Date(y, (m||1)-1, d||1);
    };
    const parseTimeToMinutes = t => { const [hh, mm] = t.split(':').map(Number); return hh*60 + (mm||0); };
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    const weekdayName = idx => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][idx];

    function combineDateTime(dateStr, timeStr){
      const d = parseDate(dateStr);
      const [hh,mm] = timeStr.split(':').map(Number);
      d.setHours(hh, mm, 0, 0);
      return d;
    }

    function isWeekend(d){ const x = d.getDay(); return x === 0 || x === 6; }
    function isHolidayDate(dateStr){ return holidays.some(h => h.date === dateStr); }
    function isWorkingDay(d){ return !isWeekend(d) && !isHolidayDate(fmtDate(d)); }

    // å–å¾—ã€Œç•¶å¤©ã€çš„å·¥ä½œæ™‚æ®µï¼ˆæ’åˆä¼‘ï¼‰ï¼š[[startMin,endMin], [startMin,endMin]]
    function getWorkIntervalsMinutes(){
      const ws = parseTimeToMinutes(WORK_START);
      const we = parseTimeToMinutes(WORK_END);
      const ls = parseTimeToMinutes(LUNCH_START);
      const le = parseTimeToMinutes(LUNCH_END);
      return [ [ws, ls], [le, we] ];
    }

    // è¨ˆç®—å…©å€‹ Date ä¹‹é–“çš„ã€Œæœ‰æ•ˆå·¥æ™‚ã€ï¼Œæ’é™¤å…­æ—¥èˆ‡åœ‹å®šå‡æ—¥ï¼Œä¸”åƒ…è¨ˆç®—ä¸Šç­æ™‚æ®µï¼ˆåˆä¼‘ä¸ç®—ï¼‰
    function calculateEffectiveWorkHours(startDT, endDT){
      if(endDT <= startDT) return 0;
      let hours = 0;
      const intervals = getWorkIntervalsMinutes();

      // é€æ—¥è¨ˆç®—
      let cur = new Date(startDT.getFullYear(), startDT.getMonth(), startDT.getDate());
      const endDay = new Date(endDT.getFullYear(), endDT.getMonth(), endDT.getDate());

      while(cur <= endDay){
        if(isWorkingDay(cur)){
          for(const [sMin, eMin] of intervals){
            const blockStart = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate(), Math.floor(sMin/60), sMin%60);
            const blockEnd   = new Date(cur.getFullYear(), cur.getMonth(), cur.getDate(), Math.floor(eMin/60), eMin%60);

            const ovStart = new Date(Math.max(blockStart.getTime(), startDT.getTime()));
            const ovEnd   = new Date(Math.min(blockEnd.getTime(), endDT.getTime()));
            if(ovEnd > ovStart){
              hours += (ovEnd - ovStart) / (1000*60*60);
            }
          }
        }
        cur.setDate(cur.getDate()+1);
      }

      // ä»¥ 0.5 å°æ™‚ç‚ºæœ€å°å–®ä½ï¼ˆå››æ¨äº”å…¥åˆ° 0.5ï¼‰
      const rounded = Math.round(hours*2)/2;
      return rounded;
    }

    function calculateLeaveHours(startDate, startTime, endDate, endTime){
      const start = combineDateTime(startDate, startTime);
      const end   = combineDateTime(endDate, endTime);
      return calculateEffectiveWorkHours(start, end);
    }

    function calculateLeaveDays(hours){
      return Math.round((hours / DAY_HOURS) * 100) / 100; // å…©ä½å°æ•¸é¡¯ç¤ºå¤©æ•¸
    }

    // å€’æ•¸åªæ’é™¤å…­æ—¥èˆ‡åœ‹å®šå‡æ—¥ï¼ˆä¸æ’å€‹äººç‰¹ä¼‘ï¼‰
    function calculateWorkingDaysTo(target){
      const today = new Date();
      const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const end   = parseDate(target);
      let count = 0;
      let cur = new Date(start);
      while(cur <= end){
        if(isWorkingDay(cur)) count++;
        cur.setDate(cur.getDate()+1);
      }
      return count;
    }

    function updateWorkingDaysCalculation(){
      const tgt = document.getElementById('targetDate').value;
      if(!tgt){
        document.getElementById('workingDaysCount').textContent = 'â€”';
        return;
      }
      const wd = calculateWorkingDaysTo(tgt);
      document.getElementById('workingDaysCount').textContent = wd;
      const d = parseDate(tgt);
      document.getElementById('countdownLabel').textContent = `è·é›¢ ${fmtDate(d)}ï¼ˆé€±${weekdayName(d.getDay())}ï¼‰å‰©é¤˜å·¥ä½œæ—¥`;

      // å‡æ—¥èˆ‡ç‰¹ä¼‘åˆ—è¡¨ï¼ˆä¾›æª¢è¦–ï¼‰ï¼šå·¦é‚Šé¡¯åœ‹å®šå‡æ—¥ã€å³é‚Šé¡¯ç‰¹ä¼‘ï¼ˆæŒ‰æ—¥æœŸæ’åºï¼‰
      const holidayList = document.getElementById('holidayList');
      const allH = [...holidays].sort((a,b)=> a.date.localeCompare(b.date));
      const leaveDays = [];
      for(const rec of leaveRecords){
        const s = parseDate(rec.startDate); const e = parseDate(rec.endDate);
        let cur = new Date(s);
        while(cur <= e){
          leaveDays.push({date: fmtDate(cur), name: rec.reason});
          cur.setDate(cur.getDate()+1);
        }
      }
      leaveDays.sort((a,b)=> a.date.localeCompare(b.date));

      const col = (title, color, arr) => `
        <div>
          <h4 class="text-sm font-medium ${color} mb-1">${title}</h4>
          <div class="space-y-1">
            ${arr.length ? arr.map(x=>`
              <div class="flex justify-between items-center p-1.5 rounded bg-slate-50">
                <span class="text-slate-700 text-sm">${x.name}</span>
                <span class="text-[11px] text-slate-500">${x.date}ï¼ˆé€±${weekdayName(parseDate(x.date).getDay())}ï¼‰</span>
              </div>`).join('') : '<div class="text-xs text-slate-400 p-1.5">ç„¡</div>'}
          </div>
        </div>`;

      holidayList.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${
          col('åœ‹å®šå‡æ—¥','text-blue-600', allH) + col('ç‰¹ä¼‘æ—¥æœŸ','text-rose-600', leaveDays)
        }</div>`;
    }

    function updateStatistics(){
      const totalUsedHours = leaveRecords.reduce((s,r)=> s + r.hours, 0);
      const totalUsedDays = leaveRecords.reduce((s,r)=> s + r.days, 0);
      const remainingHours = Math.max(0, 80 - totalUsedHours);
      const remainingDays  = Math.max(0, 10 - totalUsedDays);

      document.getElementById('usedDays').textContent = totalUsedDays.toFixed(2);
      document.getElementById('remainingDays').textContent = remainingDays.toFixed(2);
      document.getElementById('remainingHours').textContent = Math.round(remainingHours).toString();

      updateWorkingDaysCalculation();
    }

    function renderRecords(){
      const tbody = document.getElementById('leaveRecords');
      if(!leaveRecords.length){
        tbody.innerHTML = '<tr><td colspan="7" class="px-2 py-6 text-center text-slate-500 text-sm">å°šç„¡ç‰¹ä¼‘ç´€éŒ„ï¼Œè«‹æ–°å¢ç¬¬ä¸€ç­†ç”³è«‹</td></tr>';
        return;
      }
      tbody.innerHTML = leaveRecords.map(r=>`
        <tr class="hover:bg-slate-50">
          <td class="px-2 py-2 text-xs text-slate-900">${r.applicationDate}</td>
          <td class="px-2 py-2 text-xs text-slate-900">${r.startDate} ${r.startTime} è‡³ ${r.endDate} ${r.endTime}</td>
          <td class="px-2 py-2 text-xs font-medium text-blue-700">${r.days.toFixed(2)}</td>
          <td class="px-2 py-2 text-xs text-slate-900">${r.hours.toFixed(1)}h</td>
          <td class="px-2 py-2 text-xs text-slate-900">${r.reason}</td>
          <td class="px-2 py-2 text-xs text-slate-500">${r.notes || '-'}</td>
          <td class="px-2 py-2 text-xs">
            <button class="text-indigo-600 hover:text-indigo-800 font-medium mr-2" onclick="editRecord(${r.id})">ä¿®æ”¹</button>
            <button class="text-rose-600 hover:text-rose-800 font-medium" onclick="deleteRecord(${r.id})">åˆªé™¤</button>
          </td>
        </tr>`).join('');
    }

    function editRecord(id){
      const r = leaveRecords.find(x=>x.id===id);
      if(!r) return;
      document.getElementById('applicationDate').value = r.applicationDate;
      document.getElementById('leaveStartDate').value = r.startDate;
      document.getElementById('leaveStartTime').value = r.startTime;
      document.getElementById('leaveEndDate').value = r.endDate;
      document.getElementById('leaveEndTime').value = r.endTime;
      document.getElementById('reason').value = r.reason;
      document.getElementById('notes').value = r.notes || '';
      editingRecordId = id;
      document.getElementById('formTitle').textContent = 'ä¿®æ”¹ç‰¹ä¼‘ç”³è«‹';
      document.getElementById('formIcon').textContent = 'âœï¸';
      document.getElementById('submitBtn').textContent = 'æ›´æ–°ç‰¹ä¼‘ç”³è«‹';
      document.getElementById('cancelBtn').classList.remove('hidden');
      document.getElementById('leaveForm').scrollIntoView({behavior:'smooth'});
    }

    function cancelEdit(){
      editingRecordId = null;
      document.getElementById('formTitle').textContent = 'æ–°å¢ç‰¹ä¼‘ç”³è«‹';
      document.getElementById('formIcon').textContent = '+';
      document.getElementById('submitBtn').textContent = 'æ–°å¢ç‰¹ä¼‘ç”³è«‹';
      document.getElementById('cancelBtn').classList.add('hidden');
      document.getElementById('leaveForm').reset();
      const today = new Date();
      document.getElementById('applicationDate').value = fmtDate(today);
      document.getElementById('leaveStartTime').value = WORK_START;
      document.getElementById('leaveEndTime').value = WORK_END;
    }

    function deleteRecord(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç‰¹ä¼‘ç´€éŒ„å—ï¼Ÿ')) return;
      leaveRecords = leaveRecords.filter(r=>r.id!==id);
      localStorage.setItem('leaveRecords', JSON.stringify(leaveRecords));
      if(editingRecordId === id) cancelEdit();
      renderRecords();
      updateStatistics();
    }

    // ====== è¡¨å–®äº‹ä»¶ï¼šç‰¹ä¼‘ ======
    document.getElementById('leaveForm').addEventListener('submit', function(e){
      e.preventDefault();
      const applicationDate = document.getElementById('applicationDate').value;
      const startDate = document.getElementById('leaveStartDate').value;
      const startTime = document.getElementById('leaveStartTime').value;
      const endDate   = document.getElementById('leaveEndDate').value;
      const endTime   = document.getElementById('leaveEndTime').value;
      const reason    = document.getElementById('reason').value.trim();
      const notes     = document.getElementById('notes').value.trim();

      // æª¢æ ¸ï¼šçµæŸå¿…é ˆæ™šæ–¼é–‹å§‹
      const st = combineDateTime(startDate, startTime);
      const et = combineDateTime(endDate, endTime);
      if(et <= st){ alert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼'); return; }

      // æª¢æ ¸ï¼šæ™‚é–“éœ€åœ¨ä¸Šç­æ™‚æ®µå…§ï¼ˆè‡ªå‹•å¤¾åœ¨å¯ç”¨ç¯„åœï¼‰
      const ws = parseTimeToMinutes(WORK_START), we = parseTimeToMinutes(WORK_END);
      const stM = parseTimeToMinutes(startTime), etM = parseTimeToMinutes(endTime);
      if(stM < ws || stM > we || etM < ws || etM > we){
        alert(`ä¸Šç­æ™‚æ®µç‚º ${WORK_START}â€“${WORK_END}ï¼ˆåˆä¼‘ ${LUNCH_START}â€“${LUNCH_END} ä¸è¨ˆï¼‰`);
        return;
      }

      const hours = calculateLeaveHours(startDate, startTime, endDate, endTime); // å·² 0.5 ç‚ºæœ€å°å–®ä½
      if(hours <= 0){ alert('æ­¤å€é–“ç„¡å¯è¨ˆç®—çš„ä¸Šç­æ™‚æ®µï¼ˆå…­æ—¥/åœ‹å®šå‡æ—¥/åˆä¼‘ï¼‰ï¼Œè«‹èª¿æ•´æ™‚é–“ã€‚'); return; }
      const days = calculateLeaveDays(hours);

      // æª¢æ ¸ï¼šæ˜¯å¦è¶…éå‰©é¤˜ç‰¹ä¼‘ï¼ˆä¿®æ”¹æ™‚æ’é™¤åŸç´€éŒ„ï¼‰
      const usedExcludingEditing = leaveRecords.reduce((s, r)=> s + (editingRecordId && r.id===editingRecordId ? 0 : r.days), 0);
      if(usedExcludingEditing + days > 10){
        const remain = Math.max(0, 10 - usedExcludingEditing);
        alert(`ç”³è«‹å¤©æ•¸è¶…éå‰©é¤˜ç‰¹ä¼‘ï¼å‰©é¤˜å¤©æ•¸ï¼š${remain.toFixed(2)} å¤©`);
        return;
      }

      if(editingRecordId){
        const idx = leaveRecords.findIndex(r=>r.id===editingRecordId);
        if(idx>-1){
          leaveRecords[idx] = { id: editingRecordId, applicationDate, startDate, startTime, endDate, endTime, hours, days, reason, notes };
        }
        localStorage.setItem('leaveRecords', JSON.stringify(leaveRecords));
        alert('ç‰¹ä¼‘ç”³è«‹å·²æˆåŠŸæ›´æ–°ï¼');
        cancelEdit();
      }else{
        const newRecord = { id: recordIdCounter++, applicationDate, startDate, startTime, endDate, endTime, hours, days, reason, notes };
        leaveRecords.push(newRecord);
        localStorage.setItem('leaveRecords', JSON.stringify(leaveRecords));
        document.getElementById('leaveForm').reset();
        document.getElementById('applicationDate').value = fmtDate(new Date());
        document.getElementById('leaveStartTime').value = WORK_START;
        document.getElementById('leaveEndTime').value = WORK_END;
        alert('ç‰¹ä¼‘ç”³è«‹å·²æˆåŠŸæ–°å¢ï¼');
      }

      renderRecords();
      updateStatistics();
    });

    // ====== åœ‹å®šå‡æ—¥ï¼šå–®ç­†æ–°å¢ / æ¸…é™¤ ======
    document.getElementById('holidayForm').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('holidayName').value.trim();
      const date = document.getElementById('holidayDate').value;
      if(!name) { alert('è«‹è¼¸å…¥å‡æ—¥åç¨±'); return; }
      if(holidays.find(h=>h.date===date)){ alert('è©²æ—¥æœŸå·²å­˜åœ¨åœ‹å®šå‡æ—¥ï¼'); return; }
      holidays.push({ id: holidayIdCounter++, name, date });
      localStorage.setItem('holidays', JSON.stringify(holidays));
      (this).reset();
      updateWorkingDaysCalculation();
      alert('åœ‹å®šå‡æ—¥å·²æˆåŠŸæ–°å¢ï¼');
    });

    document.getElementById('clearHolidays').addEventListener('click', function(){
      if(!holidays.length){ alert('ç›®å‰æ²’æœ‰å‡æ—¥è³‡æ–™ã€‚'); return; }
      if(!confirm('ç¢ºå®šæ¸…é™¤å…¨éƒ¨åœ‹å®šå‡æ—¥ï¼Ÿ')) return;
      holidays = [];
      localStorage.setItem('holidays', JSON.stringify(holidays));
      updateWorkingDaysCalculation();
    });

    // ====== åœ‹å®šå‡æ—¥ï¼šæ‰¹æ¬¡åŒ¯å…¥ ======
    document.getElementById('bulkImport').addEventListener('click', function(ev){
      ev.preventDefault();
      const txt = document.getElementById('bulkText').value.trim();
      const overwrite = document.getElementById('bulkOverwrite').checked;
      if(!txt){ alert('è«‹è²¼ä¸Šå…§å®¹'); return; }
      const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const parsed = [];
      for(const line of lines){
        // å¯èƒ½æ˜¯ï¼šYYYY-MM-DD,åç¨± | YYYY/MM/DD åç¨± | æ—¥æœŸ[TAB]åç¨±
        let datePart = '', namePart = '';
        if(line.includes('\t')){
          const [d, n] = line.split('\t');
          datePart = d.trim(); namePart = (n||'').trim();
        }else if(line.includes(',')){
          const [d, n] = line.split(',');
          datePart = d.trim(); namePart = (n||'').trim();
        }else{
          const m = line.match(/^(\d{4}[\/-]\d{1,2}[\/-]\d{1,2})\s+(.+)$/);
          if(m){ datePart = m[1]; namePart = m[2]; }
        }
        if(!datePart || !namePart) continue;
        const d = parseDateFlex(datePart);
        const ds = fmtDate(d);
        parsed.push({ date: ds, name: namePart });
      }
      if(!parsed.length){ alert('æœªè¾¨è­˜åˆ°å¯ç”¨çš„æ—¥æœŸ/åç¨±æ ¼å¼ã€‚'); return; }

      if(overwrite){ holidays = []; }
      const exists = new Set(holidays.map(h=>h.date));
      for(const p of parsed){ if(!exists.has(p.date)) { holidays.push({ id: holidayIdCounter++, ...p }); exists.add(p.date); } }
      localStorage.setItem('holidays', JSON.stringify(holidays));
      updateWorkingDaysCalculation();
      alert(`å·²åŒ¯å…¥ ${parsed.length} ç­†ï¼ˆé‡è¤‡æ—¥æœŸè‡ªå‹•ç•¥éï¼‰`);
    });

    // ====== åˆå§‹åŒ– ======
    document.addEventListener('DOMContentLoaded', () => {
      // å¹´åº¦èµ·è¨–ï¼šèµ·å§‹ = ä»Šå¹´ 01-01ï¼›çµæŸ = èµ·å§‹ + 1 å¹´ - 1 å¤©ï¼ˆå”¯è®€ï¼‰
      const startDateInput = document.getElementById('startDate');
      const endDateInput = document.getElementById('endDate');
      const today = new Date();
      startDateInput.value = `${today.getFullYear()}-01-01`;
      const calcEnd = (s) => { if(!s) return ''; const sd = parseDate(s); const ed = new Date(sd); ed.setFullYear(sd.getFullYear()+1); ed.setDate(ed.getDate()-1); return fmtDate(ed); };
      endDateInput.value = calcEnd(startDateInput.value);
      startDateInput.addEventListener('change', () => { endDateInput.value = calcEnd(startDateInput.value); });

      // ç”³è«‹æ—¥æœŸé è¨­ä»Šå¤©
      document.getElementById('applicationDate').value = fmtDate(today);

      // æ›´å‹•é–‹å§‹æ—¥æœŸæ™‚ï¼Œé è¨­åŒæ—¥ 18:00 ç‚ºçµæŸ
      document.getElementById('leaveStartDate').addEventListener('change', function(){
        const v = this.value; if(v){ document.getElementById('leaveEndDate').value = v; document.getElementById('leaveEndTime').value = WORK_END; }
      });

      // å€’æ•¸ç›®æ¨™æ—¥é è¨­ 2026-02-14ï¼ˆæ˜¥ç¯€ï¼‰
      document.getElementById('targetDate').value = '2026-02-14';
      document.getElementById('recalcCountdown').addEventListener('click', updateWorkingDaysCalculation);

      // åˆæ¬¡æ¸²æŸ“
      renderRecords();
      updateStatistics();
      updateWorkingDaysCalculation();
    });
  </script>
</body>
</html>
